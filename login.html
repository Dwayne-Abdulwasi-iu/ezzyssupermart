<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | Vitto Restaurant</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap">
  <link rel="stylesheet" href="login.css">
</head>
<body>
  <div class="login-container">
    <h2>Login</h2>
    <div id="msg"></div>
    <form id="loginForm">
      <input type="text" id="username" placeholder="Username or Email" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <form id="signupForm">
      <input type="text" id="signupUsername" placeholder="Username" required />
      <input type="email" id="signupEmail" placeholder="Email" required />
      <input type="password" id="signupPassword" placeholder="Password" required />
      <button type="submit">Sign Up</button>
    </form>
    <div class="forgot-link">
      <a href="reset-password-otp.html">Forgot Password?</a> |
      <a href="#" onclick="showSignupForm();return false;">Sign Up</a>
    </div>
    <form id="forgotForm" style="display:none;">
      <input type="email" id="forgotEmail" placeholder="Enter your email" required />
      <button type="submit">Send Reset Link</button>
    </form>
    <form id="resetForm">
      <input type="password" id="newPassword" placeholder="New password" required />
      <button type="submit">Reset Password</button>
    </form>
    <div class="logout-link" style="margin-top:10px;text-align:center;">
      <a href="#" id="logout-btn" class="small-logout-btn" style="display:none;">Logout</a>
    </div>
  </div>
  <script>
    const form = document.getElementById('loginForm');
    const msg = document.getElementById('msg');
    const forgotForm = document.getElementById('forgotForm');
    const resetForm = document.getElementById('resetForm');
    const signupForm = document.getElementById('signupForm');
    let resetToken = '';

    form.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const email = form.username.value.trim(); // Accept username or email, but send as 'email'
      const password = form.password.value;
      if (!email || !password) {
        msg.innerHTML = '<div class="error">Please fill in all fields.</div>';
        return;
      }
      try {
        const res = await fetch('http://localhost:3001/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok && data.token) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          msg.innerHTML = '<div class="success">Login successful! Redirecting...</div>';
          setTimeout(() => window.location = 'index.html', 1200);
        } else {
          msg.innerHTML = `<div class="error">${data.message || 'Login failed'}</div>`;
        }
      } catch (err) {
        msg.innerHTML = '<div class="error">Server error. Try again later.</div>';
      }
    };

    function showForgotForm() {
      form.style.display = 'none';
      forgotForm.style.display = 'block';
      msg.innerHTML = '';
    }

    function showSignupForm() {
      form.style.display = 'none';
      forgotForm.style.display = 'none';
      resetForm.style.display = 'none';
      signupForm.style.display = 'block';
      msg.innerHTML = '';
    }

    forgotForm.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const email = document.getElementById('forgotEmail').value.trim();
      if (!email) {
        msg.innerHTML = '<div class="error">Please enter your email.</div>';
        return;
      }
      try {
        const res = await fetch('http://localhost:3001/api/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        if (res.ok) {
          msg.innerHTML = '<div class="success">Reset link sent! Check your email.</div>';
        } else {
          msg.innerHTML = `<div class="error">${data.message || 'Error sending reset link'}</div>`;
        }
      } catch (err) {
        msg.innerHTML = '<div class="error">Server error. Try again later.</div>';
      }
    };

    // For demonstration, show reset form if URL has ?reset=TOKEN
    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      if (params.has('reset')) {
        resetToken = params.get('reset');
        form.style.display = 'none';
        forgotForm.style.display = 'none';
        resetForm.style.display = 'block';
      }
    };

    resetForm.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const password = document.getElementById('newPassword').value;
      if (!password) {
        msg.innerHTML = '<div class="error">Please enter a new password.</div>';
        return;
      }
      try {
        const res = await fetch(`http://localhost:3001/api/reset-password/${resetToken}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (res.ok) {
          msg.innerHTML = '<div class="success">Password reset! You can now log in.</div>';
          setTimeout(() => { window.location = '/login.html'; }, 1500);
        } else {
          msg.innerHTML = `<div class="error">${data.message || 'Reset failed'}</div>`;
        }
      } catch (err) {
        msg.innerHTML = '<div class="error">Server error. Try again later.</div>';
      }
    };

    signupForm.onsubmit = async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const username = document.getElementById('signupUsername').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      if (!username || !email || !password) {
        msg.innerHTML = '<div class="error">Please fill in all fields.</div>';
        return;
      }
      try {
        const res = await fetch('http://localhost:3001/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });
        const data = await res.json();
        if (res.ok) {
          msg.innerHTML = '<div class="success">Registration successful! You can now log in.</div>';
          setTimeout(() => {
            signupForm.style.display = 'none';
            form.style.display = 'block';
            msg.innerHTML = '';
          }, 1500);
        } else {
          msg.innerHTML = `<div class="error">${data.message || 'Signup failed'}</div>`;
        }
      } catch (err) {
        msg.innerHTML = '<div class="error">Server error. Try again later.</div>';
      }
    };

    // Show logout if user is logged in
    function showLogoutIfLoggedIn() {
      let user = null;
      try {
        user = JSON.parse(localStorage.getItem('user'));
      } catch (e) {}
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        if (user && user.username) {
          logoutBtn.style.display = 'inline-block';
        } else {
          logoutBtn.style.display = 'none';
        }
      }
    }
    showLogoutIfLoggedIn();
    document.getElementById('logout-btn').onclick = function(e) {
      e.preventDefault();
      localStorage.removeItem('user');
      localStorage.removeItem('token');
      // Optionally clear cart or other user data
      // localStorage.removeItem('cart');
      msg.innerHTML = '<div class="success">Logged out successfully.</div>';
      setTimeout(() => { window.location = 'login.html'; }, 900);
    };
  </script>
</body>
</html>
